<div class="agents-page">
  <header class="page-header">
    <div>
      <h1>Agents</h1>
      <p>Gérer les agents de contrôle</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      Nouvel agent
    </button>
  </header>

  <!-- Filters -->
  <div class="filters">
    <div class="filter-group">
      <label>Statut</label>
      <select [(ngModel)]="filterStatus" (change)="loadAgents()">
        <option value="all">Tous</option>
        <option value="active">Actifs</option>
        <option value="inactive">Inactifs</option>
      </select>
    </div>
    <div class="search-box">
      <input
        type="text"
        placeholder="Rechercher un agent..."
        [(ngModel)]="searchQuery"
        (input)="filterAgents()"
      />
    </div>
  </div>

  @if (isLoading) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Chargement...</p>
    </div>
  } @else {
    <!-- Desktop Table View -->
    <div class="table-container desktop-only">
      <table class="data-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Username</th>
            <th>Téléphone</th>
            <th>Zones</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (agent of filteredAgents; track agent._id) {
            <tr>
              <td>{{ agent.name }}</td>
              <td class="username">{{ agent.username }}</td>
              <td>{{ agent.phone || '-' }}</td>
              <td>
                @if (agent.assignedZones && agent.assignedZones.length > 0) {
                  <span class="badge">{{ agent.assignedZones.length }} zones</span>
                } @else {
                  <span class="text-muted">Aucune</span>
                }
              </td>
              <td>
                <span class="status" [class.active]="agent.isActive" [class.inactive]="!agent.isActive">
                  {{ agent.isActive ? 'Actif' : 'Inactif' }}
                </span>
              </td>
              <td class="actions">
                <button class="btn-icon" title="Modifier" (click)="openEditModal(agent)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </button>
                <button class="btn-icon danger" title="Supprimer" (click)="deleteAgent(agent)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="6" class="empty">Aucun agent trouvé</td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Mobile Card View -->
    <div class="mobile-cards mobile-only">
      @for (agent of filteredAgents; track agent._id) {
        <div class="mobile-card" [class.inactive-card]="!agent.isActive">
          <div class="card-header">
            <div class="agent-info">
              <div class="agent-avatar" [class.inactive]="!agent.isActive">
                {{ agent.name.charAt(0).toUpperCase() }}
              </div>
              <div class="agent-details">
                <span class="agent-name">{{ agent.name }}</span>
                <span class="agent-username">{{ agent.username }}</span>
              </div>
            </div>
            <span class="status" [class.active]="agent.isActive" [class.inactive]="!agent.isActive">
              {{ agent.isActive ? 'Actif' : 'Inactif' }}
            </span>
          </div>
          <div class="card-body">
            <div class="card-row">
              <span class="card-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
                Téléphone
              </span>
              <span class="card-value">{{ agent.phone || '-' }}</span>
            </div>
            <div class="card-row">
              <span class="card-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
                Zones
              </span>
              @if (agent.assignedZones && agent.assignedZones.length > 0) {
                <span class="badge">{{ agent.assignedZones.length }} zones</span>
              } @else {
                <span class="card-value text-muted">Aucune</span>
              }
            </div>
          </div>
          <div class="card-actions">
            <button class="btn-action primary" (click)="openEditModal(agent)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              Modifier
            </button>
            <button class="btn-action danger" (click)="deleteAgent(agent)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
              Supprimer
            </button>
          </div>
        </div>
      } @empty {
        <div class="empty-state">
          <p>Aucun agent trouvé</p>
        </div>
      }
    </div>

    <div class="table-footer">
      <span>{{ filteredAgents.length }} agent(s) sur {{ agents.length }}</span>
    </div>
  }

  <!-- Create Modal -->
  @if (showCreateModal) {
    <div class="modal-overlay" (click)="closeCreateModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Nouvel agent</h2>
          <button class="close-btn" (click)="closeCreateModal()">&times;</button>
        </div>
        <form (ngSubmit)="createAgent()">
          <div class="form-group">
            <label>Nom complet *</label>
            <input type="text" [(ngModel)]="newAgent.name" name="name" required placeholder="Jean Dupont" />
          </div>
          <div class="form-group">
            <label>Username *</label>
            <input type="text" [(ngModel)]="newAgent.username" name="username" required placeholder="jean.dupont" />
          </div>
          <div class="form-group">
            <label>Mot de passe *</label>
            <div class="password-input-group">
              <input [type]="showPassword ? 'text' : 'password'" [(ngModel)]="newAgent.password" name="password" required minlength="6" placeholder="Min. 6 caractères" />
              <button type="button" class="btn-icon-sm" (click)="showPassword = !showPassword" title="Afficher/Masquer">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  @if (showPassword) {
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                  } @else {
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  }
                </svg>
              </button>
              <button type="button" class="btn btn-sm btn-secondary" (click)="generatePassword()" title="Générer un mot de passe">
                Générer
              </button>
            </div>
          </div>
          <div class="form-group">
            <label>Téléphone</label>
            <input type="tel" [(ngModel)]="newAgent.phone" name="phone" placeholder="+212 6XX XXX XXX" />
          </div>
          <div class="form-group">
            <app-zone-selector
              [(selectedZoneIds)]="newAgentZones"
            ></app-zone-selector>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">Annuler</button>
            <button type="submit" class="btn btn-primary" [disabled]="isSaving">
              {{ isSaving ? 'Création...' : 'Créer' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Edit Modal -->
  @if (showEditModal && editAgent) {
    <div class="modal-overlay" (click)="closeEditModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Modifier l'agent</h2>
          <button class="close-btn" (click)="closeEditModal()">&times;</button>
        </div>
        <form (ngSubmit)="updateAgent()">
          <div class="form-group">
            <label>Nom complet *</label>
            <input type="text" [(ngModel)]="editAgent.name" name="editName" required placeholder="Jean Dupont" />
          </div>
          <div class="form-group">
            <label>Username *</label>
            <input type="text" [(ngModel)]="editAgent.username" name="editUsername" required placeholder="jean.dupont" />
          </div>
          <div class="form-group">
            <label>Téléphone</label>
            <input type="tel" [(ngModel)]="editAgent.phone" name="editPhone" placeholder="+212 6XX XXX XXX" />
          </div>
          <div class="form-group">
            <label>Nouveau mot de passe</label>
            <div class="password-input-group">
              <input [type]="showEditPassword ? 'text' : 'password'" [(ngModel)]="editPassword" name="editPassword" minlength="6" placeholder="Laisser vide pour ne pas changer" />
              <button type="button" class="btn-icon-sm" (click)="showEditPassword = !showEditPassword" title="Afficher/Masquer">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  @if (showEditPassword) {
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                  } @else {
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  }
                </svg>
              </button>
              <button type="button" class="btn btn-sm btn-secondary" (click)="generateEditPassword()" title="Générer un mot de passe">
                Générer
              </button>
            </div>
          </div>
          <div class="form-group">
            <app-zone-selector
              [(selectedZoneIds)]="editAgentZones"
            ></app-zone-selector>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="editAgent.isActive" name="editIsActive" />
              Agent actif
            </label>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Annuler</button>
            <button type="submit" class="btn btn-primary" [disabled]="isSaving">
              {{ isSaving ? 'Enregistrement...' : 'Enregistrer' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Toast Message -->
  @if (message) {
    <div class="toast" [class]="message.type">
      {{ message.text }}
    </div>
  }
</div>
