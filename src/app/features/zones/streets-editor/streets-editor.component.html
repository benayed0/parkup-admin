<div class="editor-container">
  <aside class="sidebar" [class.open]="sidebarOpen">
    <div class="sidebar-header">
      <button class="back-btn" (click)="close()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        Retour
      </button>
      <button class="close-sidebar" (click)="sidebarOpen = false">
        &times;
      </button>
    </div>

    <div class="zone-summary">
      <div class="zone-code-badge large">{{ zone.code }}</div>
      <h2>{{ zone.name }}</h2>
      <p>{{ zone.description || 'Aucune description' }}</p>
    </div>

    <!-- Street Type Selector -->
    <div class="section">
      <label>Type de rue a dessiner</label>
      <div class="street-types">
        @for (type of streetTypes; track type.value) {
        <button
          class="type-btn"
          [class.active]="selectedStreetType === type.value"
          [style.border-color]="type.color"
          [style.background-color]="
            selectedStreetType === type.value ? type.color : 'transparent'
          "
          (click)="selectedStreetType = type.value; onStreetTypeChange()"
        >
          <span
            class="color-dot"
            [style.background-color]="type.color"
          ></span>
          {{ type.label }}
        </button>
        }
      </div>
    </div>

    <!-- Zone Boundary Section -->
    <div class="section">
      <label>Limite de zone</label>
      <div class="boundary-controls">
        @if (zoneBoundary) {
          <div class="boundary-status has-boundary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            Limite definie ({{ zoneBoundary.coordinates.length }} points)
          </div>
          <div class="boundary-actions">
            @if (isEditingBoundary) {
              <button class="btn btn-sm btn-success" (click)="finishEditingBoundary()">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Terminer
              </button>
              <button class="btn btn-sm btn-secondary" (click)="cancelEditingBoundary()">
                Annuler
              </button>
            } @else {
              <button class="btn btn-sm btn-info" (click)="startEditingBoundary()">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Modifier
              </button>
              <button class="btn btn-sm btn-danger-outline" (click)="clearBoundary()">
                Effacer
              </button>
            }
          </div>
          @if (isEditingBoundary) {
            <p class="hint edit-hint">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
              Glissez les points pour modifier la limite
            </p>
          }
        } @else {
          <div class="boundary-status no-boundary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            Aucune limite
          </div>
          <p class="hint">Utilisez l'outil polygone pour dessiner la limite</p>
        }
        @if (hasUnsavedBoundary()) {
          <button
            class="btn btn-sm btn-success full-width"
            [disabled]="isSavingBoundary || isEditingBoundary"
            (click)="saveBoundary()"
          >
            @if (isSavingBoundary) { Sauvegarde... } @else { Sauvegarder limite }
          </button>
        }
      </div>
    </div>

    <!-- Statistics -->
    <div class="section stats">
      <div class="stat">
        <span class="stat-value">{{ getExistingStreetsCount() }}</span>
        <span class="stat-label">Rues existantes</span>
      </div>
      <div class="stat">
        <span class="stat-value">{{ getNewStreetsCount() }}</span>
        <span class="stat-label">Nouvelles rues</span>
      </div>
    </div>

    <!-- Actions -->
    <div class="section actions">
      <button
        class="btn btn-primary"
        [disabled]="isSaving || getNewStreetsCount() === 0"
        (click)="saveStreets()"
      >
        @if (isSaving) { Sauvegarde... } @else { Sauvegarder ({{
          getNewStreetsCount()
        }}) }
      </button>

      <button
        class="btn btn-secondary"
        [disabled]="drawnStreets.length === 0"
        (click)="clearMap()"
      >
        Effacer la carte
      </button>

      <button
        class="btn btn-danger-outline"
        [disabled]="isSaving || getExistingStreetsCount() === 0"
        (click)="deleteAllStreets()"
      >
        Supprimer tout
      </button>
    </div>

    <!-- Instructions -->
    <div class="section instructions">
      <h3>Instructions</h3>
      <ol>
        <li>Selectionnez le type de rue</li>
        <li>Cliquez sur l'icone ligne dans la carte</li>
        <li>Dessinez la rue point par point</li>
        <li>Double-cliquez pour terminer</li>
        <li>Sauvegardez vos modifications</li>
      </ol>
    </div>

    <!-- Message -->
    @if (mapMessage) {
    <div class="message" [class]="mapMessage.type">
      {{ mapMessage.text }}
    </div>
    }
  </aside>

  <!-- Mobile Toggle -->
  <button
    class="sidebar-toggle"
    (click)="sidebarOpen = !sidebarOpen"
    [class.open]="sidebarOpen"
  >
    <span class="toggle-icon"></span>
  </button>

  @if (sidebarOpen) {
  <div class="sidebar-backdrop" (click)="sidebarOpen = false"></div>
  }

  <!-- Map -->
  <main class="map-container">
    <div id="streets-map"></div>
    @if (isLoadingStreets) {
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>Chargement des rues...</p>
    </div>
    }
  </main>
</div>
